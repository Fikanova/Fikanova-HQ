---
import Layout from '../layouts/Layout.astro';

// SSR: Check for auth cookie/session
const sessionCookie = Astro.cookies.get('session');
const isLoggedIn = !!sessionCookie?.value;

// Redirect to dashboard if already logged in
if (isLoggedIn) {
    return Astro.redirect('/dashboard');
}
---

<Layout title="Login">
    <div class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white p-8 rounded-2xl shadow-xl max-w-md w-full">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-slate-900 mb-2">Client Portal</h1>
                <p class="text-slate-500">Manage your projects, invoices, and analytics</p>
            </div>

            <form id="loginForm" class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">Email</label>
                    <input 
                        type="email" 
                        id="email"
                        required
                        class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="you@example.com"
                    >
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">Password</label>
                    <input 
                        type="password" 
                        id="password"
                        required
                        class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="••••••••"
                    >
                </div>

                <div id="errorMessage" class="hidden bg-red-50 text-red-600 p-3 rounded-lg text-sm"></div>

                <button 
                    type="submit"
                    class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 rounded-lg transition"
                >
                    Sign In
                </button>
            </form>

            <div class="mt-6 text-center">
                <p class="text-slate-500 text-sm">
                    Don't have an account? 
                    <a href="/register" class="text-blue-600 hover:underline">Register</a>
                </p>
            </div>

            <div class="mt-8 pt-6 border-t border-slate-200 text-center">
                <p class="text-xs text-slate-400">Powered by Appwrite Auth</p>
            </div>
        </div>
    </div>

    <script is:inline>
        const { Client, Account } = Appwrite;
        
        const client = new Client()
            .setEndpoint('https://fra.cloud.appwrite.io/v1')
            .setProject('6936df5800371a655e8e');
        
        const account = new Account(client);

        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('errorMessage');
            
            errorDiv.classList.add('hidden');
            
            try {
                // Create session
                await account.createEmailPasswordSession(email, password);
                
                // Get user to check teams
                const user = await account.get();
                
                // Store session indicator
                document.cookie = 'session=active; path=/; max-age=86400';
                
                // Redirect to dashboard
                window.location.href = '/dashboard';
            } catch (error) {
                errorDiv.textContent = error.message || 'Login failed. Please try again.';
                errorDiv.classList.remove('hidden');
            }
        });
    </script>
</Layout>
