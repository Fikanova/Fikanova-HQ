---
/**
 * Validate - 3-Tier Security Hub
 * Tier 1 Sandbox submission auditing
 * Tier 2 Supervisor Review Dashboard
 * Tier 3 Production Kernel status
 */
import Layout from '../layouts/Layout.astro';
import { Client, Databases, Query, Account } from 'appwrite';

// Initialize Appwrite
const client = new Client()
    .setEndpoint(import.meta.env.VITE_APPWRITE_ENDPOINT || 'https://cloud.appwrite.io/v1')
    .setProject(import.meta.env.VITE_APPWRITE_PROJECT_ID || '');

const databases = new Databases(client);
const DATABASE_ID = import.meta.env.VITE_APPWRITE_DATABASE_ID || '693703ef001133c62d78';

// Fetch pending skill submissions
let sandboxSubmissions: any[] = [];
let learningTraces: any[] = [];

try {
    // Fetch from Skills collection (status = 'pending')
    const skillsResponse = await databases.listDocuments(
        DATABASE_ID,
        'Skills',
        [Query.equal('status', 'pending'), Query.orderDesc('$createdAt'), Query.limit(20)]
    );
    sandboxSubmissions = skillsResponse.documents;
} catch (e) {
    console.log('Could not fetch sandbox submissions');
}

try {
    // Fetch recent learning traces
    const tracesResponse = await databases.listDocuments(
        DATABASE_ID,
        'Learning_Traces',
        [Query.orderDesc('logged_at'), Query.limit(10)]
    );
    learningTraces = tracesResponse.documents;
} catch (e) {
    console.log('Could not fetch learning traces');
}

function formatDate(dateString: string): string {
    return new Date(dateString).toLocaleString('en-US', {
        month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
    });
}
---

<Layout title="Validate - 3-Tier Security Hub">
    <div class="validate-page">
        <!-- Header -->
        <header class="validate-header">
            <div class="header-content">
                <h1><i class="fas fa-shield-alt"></i> Validation Hub</h1>
                <p>3-Tier Security Protocol â€¢ Human-in-the-Loop Oversight</p>
            </div>
            <div class="header-actions">
                <button id="refreshBtn" class="btn-icon">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>
        </header>

        <main class="validate-main">
            <!-- 3-Tier Overview -->
            <section class="tiers-overview">
                <div class="tier-card tier-1">
                    <div class="tier-icon"><i class="fas fa-flask"></i></div>
                    <div class="tier-info">
                        <h3>Tier 1: Sandbox</h3>
                        <p>Trainer skill drafts pending review</p>
                        <span class="tier-count">{sandboxSubmissions.length}</span>
                    </div>
                    <div class="tier-status active">
                        <span class="status-dot"></span>
                        ACTIVE
                    </div>
                </div>

                <div class="tier-card tier-2">
                    <div class="tier-icon"><i class="fas fa-user-check"></i></div>
                    <div class="tier-info">
                        <h3>Tier 2: Validation</h3>
                        <p>Supervisor review queue</p>
                        <span class="tier-count">{sandboxSubmissions.filter((s: any) => s.priority === 'high').length}</span>
                    </div>
                    <div class="tier-status monitoring">
                        <span class="status-dot"></span>
                        YOU ARE HERE
                    </div>
                </div>

                <div class="tier-card tier-3">
                    <div class="tier-icon"><i class="fas fa-server"></i></div>
                    <div class="tier-info">
                        <h3>Tier 3: Core</h3>
                        <p>Production kernel (Railway)</p>
                        <span class="tier-count">LIVE</span>
                    </div>
                    <div class="tier-status healthy">
                        <span class="status-dot"></span>
                        HEALTHY
                    </div>
                </div>
            </section>

            <!-- Sandbox Submissions Queue -->
            <section class="submissions-section">
                <div class="section-header">
                    <h2><i class="fas fa-inbox"></i> Sandbox Submissions</h2>
                    <div class="filter-tabs">
                        <button class="filter-tab active" data-filter="all">All</button>
                        <button class="filter-tab" data-filter="high">High Priority</button>
                        <button class="filter-tab" data-filter="pending">Pending</button>
                    </div>
                </div>

                <div class="submissions-table">
                    <div class="table-header">
                        <span>Skill Name</span>
                        <span>Trainer</span>
                        <span>Type</span>
                        <span>Submitted</span>
                        <span>Priority</span>
                        <span>Actions</span>
                    </div>

                    {sandboxSubmissions.length === 0 ? (
                        <div class="empty-state">
                            <i class="fas fa-check-circle"></i>
                            <h3>Queue Clear</h3>
                            <p>No pending submissions to review</p>
                        </div>
                    ) : (
                        sandboxSubmissions.map((submission: any) => (
                            <div class="table-row" data-priority={submission.priority || 'medium'}>
                                <span class="skill-name">
                                    <i class="fas fa-puzzle-piece"></i>
                                    {submission.name || 'Unnamed Skill'}
                                </span>
                                <span class="trainer">
                                    {submission.author || 'Anonymous'}
                                </span>
                                <span class="skill-type">
                                    <span class="type-badge">{submission.agent_type || 'L3'}</span>
                                </span>
                                <span class="submitted-at">
                                    {formatDate(submission.$createdAt)}
                                </span>
                                <span class="priority">
                                    <span class={`priority-badge ${submission.priority || 'medium'}`}>
                                        {submission.priority?.toUpperCase() || 'MEDIUM'}
                                    </span>
                                </span>
                                <span class="actions">
                                    <button class="action-btn approve" data-id={submission.$id} title="Approve to Core">
                                        <i class="fas fa-check"></i>
                                    </button>
                                    <button class="action-btn review" data-id={submission.$id} title="View Details">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="action-btn reject" data-id={submission.$id} title="Reject">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </span>
                            </div>
                        ))
                    )}
                </div>
            </section>

            <!-- Learning Traces (CimpO Feed) -->
            <section class="traces-section">
                <div class="section-header">
                    <h2><i class="fas fa-graduation-cap"></i> Learning Traces</h2>
                    <span class="badge">CimpO Feed</span>
                </div>

                <div class="traces-feed">
                    {learningTraces.length === 0 ? (
                        <div class="empty-feed">
                            <p>No learning traces recorded yet</p>
                        </div>
                    ) : (
                        learningTraces.map((trace: any) => (
                            <div class="trace-item">
                                <div class="trace-agent">
                                    <span class="agent-badge">{trace.agent_name}</span>
                                    <time>{formatDate(trace.logged_at)}</time>
                                </div>
                                <p class="trace-observation">{trace.observation}</p>
                                {trace.action_taken && (
                                    <p class="trace-action">
                                        <i class="fas fa-arrow-right"></i> {trace.action_taken}
                                    </p>
                                )}
                            </div>
                        ))
                    )}
                </div>
            </section>
        </main>
    </div>
</Layout>

<style>
    .validate-page {
        min-height: 100vh;
        background: var(--dark-bg);
    }

    .validate-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 24px 32px;
        background: var(--dark-surface);
        border-bottom: 1px solid var(--border-subtle);
    }

    .validate-header h1 {
        display: flex;
        align-items: center;
        gap: 12px;
        font-size: 24px;
        margin-bottom: 4px;
    }

    .validate-header h1 i {
        color: var(--primary);
    }

    .validate-header p {
        color: var(--text-secondary);
        font-size: 14px;
    }

    .btn-icon {
        width: 40px;
        height: 40px;
        background: var(--dark-card);
        border: 1px solid var(--border-subtle);
        border-radius: 10px;
        color: var(--text-secondary);
        cursor: pointer;
        transition: all 0.2s;
    }

    .btn-icon:hover {
        border-color: var(--primary);
        color: var(--primary);
    }

    .validate-main {
        padding: 32px;
        max-width: 1400px;
        margin: 0 auto;
    }

    /* Tiers Overview */
    .tiers-overview {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 20px;
        margin-bottom: 40px;
    }

    .tier-card {
        background: var(--dark-card);
        border: 1px solid var(--border-subtle);
        border-radius: 16px;
        padding: 24px;
        display: flex;
        align-items: center;
        gap: 16px;
    }

    .tier-card.tier-1 { border-left: 4px solid #f59e0b; }
    .tier-card.tier-2 { border-left: 4px solid var(--primary); }
    .tier-card.tier-3 { border-left: 4px solid #22c55e; }

    .tier-icon {
        width: 50px;
        height: 50px;
        background: rgba(139, 92, 246, 0.15);
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        color: var(--primary);
    }

    .tier-info {
        flex: 1;
    }

    .tier-info h3 {
        font-size: 16px;
        margin-bottom: 4px;
    }

    .tier-info p {
        font-size: 12px;
        color: var(--text-tertiary);
        margin-bottom: 8px;
    }

    .tier-count {
        font-size: 24px;
        font-weight: 700;
        color: var(--primary);
    }

    .tier-status {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 10px;
        font-weight: 700;
        letter-spacing: 0.5px;
        padding: 6px 10px;
        border-radius: 6px;
    }

    .tier-status .status-dot {
        width: 6px;
        height: 6px;
        border-radius: 50%;
    }

    .tier-status.active {
        background: rgba(245, 158, 11, 0.15);
        color: #f59e0b;
    }
    .tier-status.active .status-dot { background: #f59e0b; }

    .tier-status.monitoring {
        background: rgba(139, 92, 246, 0.15);
        color: var(--primary);
    }
    .tier-status.monitoring .status-dot { background: var(--primary); }

    .tier-status.healthy {
        background: rgba(34, 197, 94, 0.15);
        color: #22c55e;
    }
    .tier-status.healthy .status-dot { background: #22c55e; }

    /* Submissions Section */
    .submissions-section {
        background: var(--dark-card);
        border: 1px solid var(--border-subtle);
        border-radius: 16px;
        overflow: hidden;
        margin-bottom: 32px;
    }

    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px 24px;
        border-bottom: 1px solid var(--border-subtle);
    }

    .section-header h2 {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 16px;
    }

    .section-header h2 i {
        color: var(--primary);
    }

    .filter-tabs {
        display: flex;
        gap: 8px;
    }

    .filter-tab {
        padding: 8px 16px;
        background: transparent;
        border: 1px solid var(--border-subtle);
        border-radius: 8px;
        color: var(--text-secondary);
        font-size: 12px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .filter-tab:hover, .filter-tab.active {
        background: var(--primary);
        border-color: var(--primary);
        color: white;
    }

    .submissions-table {
        padding: 0 24px 24px;
    }

    .table-header {
        display: grid;
        grid-template-columns: 2fr 1fr 1fr 1fr 100px 120px;
        padding: 12px 16px;
        font-size: 11px;
        font-weight: 600;
        color: var(--text-tertiary);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border-bottom: 1px solid var(--border-subtle);
    }

    .table-row {
        display: grid;
        grid-template-columns: 2fr 1fr 1fr 1fr 100px 120px;
        align-items: center;
        padding: 16px;
        border-bottom: 1px solid var(--border-subtle);
        transition: background 0.2s;
    }

    .table-row:hover {
        background: rgba(139, 92, 246, 0.05);
    }

    .table-row:last-child {
        border-bottom: none;
    }

    .skill-name {
        display: flex;
        align-items: center;
        gap: 10px;
        font-weight: 600;
    }

    .skill-name i {
        color: var(--primary);
    }

    .trainer {
        color: var(--text-secondary);
        font-size: 13px;
    }

    .type-badge {
        padding: 4px 10px;
        background: rgba(59, 130, 246, 0.15);
        color: #3b82f6;
        border-radius: 4px;
        font-size: 11px;
        font-weight: 600;
    }

    .submitted-at {
        font-size: 13px;
        color: var(--text-tertiary);
    }

    .priority-badge {
        padding: 4px 10px;
        border-radius: 4px;
        font-size: 10px;
        font-weight: 700;
    }

    .priority-badge.high {
        background: rgba(239, 68, 68, 0.15);
        color: #ef4444;
    }

    .priority-badge.medium {
        background: rgba(245, 158, 11, 0.15);
        color: #f59e0b;
    }

    .priority-badge.low {
        background: rgba(107, 114, 128, 0.15);
        color: #9ca3af;
    }

    .actions {
        display: flex;
        gap: 8px;
    }

    .action-btn {
        width: 32px;
        height: 32px;
        border: 1px solid var(--border-subtle);
        border-radius: 8px;
        background: transparent;
        color: var(--text-secondary);
        cursor: pointer;
        transition: all 0.2s;
    }

    .action-btn.approve:hover {
        background: rgba(34, 197, 94, 0.15);
        border-color: #22c55e;
        color: #22c55e;
    }

    .action-btn.review:hover {
        background: rgba(59, 130, 246, 0.15);
        border-color: #3b82f6;
        color: #3b82f6;
    }

    .action-btn.reject:hover {
        background: rgba(239, 68, 68, 0.15);
        border-color: #ef4444;
        color: #ef4444;
    }

    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: var(--text-tertiary);
    }

    .empty-state i {
        font-size: 48px;
        margin-bottom: 16px;
        opacity: 0.5;
        color: #22c55e;
    }

    .empty-state h3 {
        margin-bottom: 8px;
        color: var(--text-primary);
    }

    /* Traces Section */
    .traces-section {
        background: var(--dark-card);
        border: 1px solid var(--border-subtle);
        border-radius: 16px;
        overflow: hidden;
    }

    .traces-section .section-header .badge {
        padding: 4px 10px;
        background: rgba(6, 182, 212, 0.15);
        color: #06b6d4;
        border-radius: 4px;
        font-size: 11px;
        font-weight: 600;
    }

    .traces-feed {
        padding: 16px 24px;
        max-height: 400px;
        overflow-y: auto;
    }

    .trace-item {
        padding: 16px;
        background: rgba(255, 255, 255, 0.02);
        border-radius: 10px;
        margin-bottom: 12px;
        border-left: 3px solid var(--primary);
    }

    .trace-agent {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 8px;
    }

    .agent-badge {
        padding: 4px 10px;
        background: rgba(139, 92, 246, 0.15);
        color: var(--primary);
        border-radius: 4px;
        font-size: 11px;
        font-weight: 700;
    }

    .trace-agent time {
        font-size: 11px;
        color: var(--text-tertiary);
    }

    .trace-observation {
        font-size: 13px;
        color: var(--text-secondary);
        margin-bottom: 8px;
    }

    .trace-action {
        font-size: 12px;
        color: #22c55e;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .empty-feed {
        text-align: center;
        padding: 40px;
        color: var(--text-tertiary);
    }

    @media (max-width: 1024px) {
        .tiers-overview {
            grid-template-columns: 1fr;
        }

        .table-header, .table-row {
            grid-template-columns: 1fr 1fr 80px;
        }

        .table-header span:nth-child(2),
        .table-header span:nth-child(4),
        .table-row span:nth-child(2),
        .table-row span:nth-child(4) {
            display: none;
        }
    }
</style>

<script is:inline>
    // Refresh button
    document.getElementById('refreshBtn')?.addEventListener('click', () => {
        window.location.reload();
    });

    // Filter tabs
    document.querySelectorAll('.filter-tab').forEach(tab => {
        tab.addEventListener('click', () => {
            document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            
            const filter = tab.dataset.filter;
            document.querySelectorAll('.table-row').forEach(row => {
                if (filter === 'all') {
                    row.style.display = '';
                } else if (filter === 'high') {
                    row.style.display = row.dataset.priority === 'high' ? '' : 'none';
                } else {
                    row.style.display = '';
                }
            });
        });
    });

    // Action buttons (placeholder)
    document.querySelectorAll('.action-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const id = btn.dataset.id;
            if (btn.classList.contains('approve')) {
                alert(`Skill ${id} approved and promoted to Core`);
            } else if (btn.classList.contains('reject')) {
                if (confirm('Reject this skill submission?')) {
                    alert(`Skill ${id} rejected`);
                }
            }
        });
    });
</script>
