---
import Icon from '../components/Icon.astro';
import SocialIcon from '../components/SocialIcon.astro';
/**
 * The Termite Stack - Newsletter & Dispatches
 * CIO.com HOMEPAGE-inspired design with featured hero, article grid,
 * and category sections
 */
import Layout from '../layouts/Layout.astro';
import { Client, Databases, Query } from 'appwrite';

// Initialize Appwrite client
const client = new Client()
    .setEndpoint(import.meta.env.VITE_APPWRITE_ENDPOINT || 'https://fra.cloud.appwrite.io/v1')
    .setProject(import.meta.env.VITE_APPWRITE_PROJECT_ID || '6936df5800371a655e8e');

const databases = new Databases(client);
const DATABASE_ID = import.meta.env.VITE_APPWRITE_DATABASE_ID || '693703ef001133c62d78';
const ARTICLES_COLLECTION_ID = 'Articles';

// Fetch articles from Appwrite
let articles: any[] = [];
let fetchError = false;

try {
    const response = await databases.listDocuments(
        DATABASE_ID,
        ARTICLES_COLLECTION_ID,
        [
            Query.orderDesc('published_at'),
            Query.limit(50)
        ]
    );
    articles = response.documents;
    console.log(`Fetched ${articles.length} articles from Appwrite`);
} catch (error: any) {
    console.error('Error fetching articles from Appwrite:', error?.message || error);
    fetchError = true;
}

// Helper to format date
function formatDate(dateString: string): string {
    const date = new Date(dateString);
    return date.toLocaleDateString('en-US', {
        month: 'short',
        day: 'numeric',
        year: 'numeric'
    });
}

// Helper to calculate read time
function calculateReadTime(content: string): number {
    const words = content?.split(/\s+/).length || 0;
    return Math.max(1, Math.ceil(words / 200));
}

// Helper to get category label
function getCategoryLabel(tags: string): string {
    const tagList = tags?.toLowerCase() || '';
    if (tagList.includes('agent')) return 'AGENTS';
    if (tagList.includes('automation')) return 'AUTOMATION';
    if (tagList.includes('strategy') || tagList.includes('business')) return 'STRATEGY';
    if (tagList.includes('open source')) return 'OPEN SOURCE';
    if (tagList.includes('tools')) return 'TOOLS';
    return 'AI INSIGHTS';
}

// Generate placeholder image based on tags
function getArticleImage(article: any): string {
    const tags = article.tags?.toLowerCase() || '';
    if (tags.includes('anthropic') || tags.includes('mcp')) {
        return 'https://images.unsplash.com/photo-1555066931-4365d14bab8c?w=800&q=80';
    } else if (tags.includes('gemini') || tags.includes('google')) {
        return 'https://images.unsplash.com/photo-1677442136019-21780ecad995?w=800&q=80';
    } else if (tags.includes('agent')) {
        return 'https://images.unsplash.com/photo-1485827404703-89b55fcc595e?w=800&q=80';
    } else if (tags.includes('automation') || tags.includes('n8n')) {
        return 'https://images.unsplash.com/photo-1518432031352-d6fc5c10da5a?w=800&q=80';
    }
    return 'https://images.unsplash.com/photo-1620712943543-bcc4688e7485?w=800&q=80';
}

// Featured article is the first one
const featuredArticle = articles[0];
const gridArticles = articles.slice(1, 7); // Next 6 for main grid
const moreArticles = articles.slice(7); // Rest for "More" section
---

<Layout title="The Termite Stack - AI Newsletter">
    <!-- Page Header -->
    <section class="newsletter-header">
        <div class="container">
            <div class="header-content">
                <span class="section-badge">THE TERMITE STACK</span>
                <h1>AI Strategy <span class="accent">Newsletter</span></h1>
                <p>Weekly insights on AI agents, automation, and building systems that work.</p>
            </div>
        </div>
    </section>

    <!-- Main Content -->
    <main class="newsletter-main">
        <div class="container">
            {fetchError ? (
                <div class="empty-state">
                    <Icon name="exclamation-triangle" size={24} />
                    <h3>Unable to Load Articles</h3>
                    <p>We're having trouble connecting. Please check back later.</p>
                </div>
            ) : articles.length === 0 ? (
                <div class="empty-state">
                    <Icon name="newspaper" size={24} />
                    <h3>Coming Soon</h3>
                    <p>We're preparing our first dispatches. Subscribe below to be notified.</p>
                </div>
            ) : (
                <>
                    <!-- Hero Featured Article (CIO-style) -->
                    {featuredArticle && (
                        <section class="hero-featured">
                            <a href={`/newsletter/${featuredArticle.slug}`} class="hero-link">
                                <div class="hero-image">
                                    <img src={getArticleImage(featuredArticle)} alt={featuredArticle.title} loading="eager" />
                                    <span class="hero-category">{getCategoryLabel(featuredArticle.tags)}</span>
                                </div>
                                <div class="hero-content">
                                    <h2>{featuredArticle.title}</h2>
                                    <p class="hero-excerpt">{featuredArticle.excerpt}</p>
                                    <div class="hero-meta">
                                        <span class="author">{featuredArticle.author || 'Nyaenya Moseti'}</span>
                                        <span class="separator">•</span>
                                        <time datetime={featuredArticle.published_at}>
                                            {formatDate(featuredArticle.published_at)}
                                        </time>
                                        <span class="separator">•</span>
                                        <span class="read-time">{calculateReadTime(featuredArticle.content)} min read</span>
                                    </div>
                                </div>
                            </a>
                        </section>
                    )}

                    <!-- Article Grid (CIO 3-column style) -->
                    {gridArticles.length > 0 && (
                        <section class="article-grid-section">
                            <h3 class="section-title">Latest Dispatches</h3>
                            <div class="article-grid">
                                {gridArticles.map((article) => (
                                    <article class="article-card">
                                        <a href={`/newsletter/${article.slug}`} class="card-link">
                                            <div class="card-image">
                                                <img src={getArticleImage(article)} alt={article.title} loading="lazy" />
                                                <span class="card-category">{getCategoryLabel(article.tags)}</span>
                                            </div>
                                            <div class="card-content">
                                                <h4>{article.title}</h4>
                                                <p class="card-excerpt">{article.excerpt}</p>
                                                <div class="card-meta">
                                                    <span class="author">{article.author || 'Nyaenya Moseti'}</span>
                                                    <span class="separator">•</span>
                                                    <time datetime={article.published_at}>
                                                        {formatDate(article.published_at)}
                                                    </time>
                                                </div>
                                            </div>
                                        </a>
                                    </article>
                                ))}
                            </div>
                        </section>
                    )}

                    <!-- More Articles List -->
                    {moreArticles.length > 0 && (
                        <section class="more-articles-section">
                            <h3 class="section-title">More Articles</h3>
                            <div class="more-articles-list">
                                {moreArticles.map((article) => (
                                    <article class="list-article">
                                        <a href={`/newsletter/${article.slug}`} class="list-link">
                                            <span class="list-category">{getCategoryLabel(article.tags)}</span>
                                            <h4>{article.title}</h4>
                                            <div class="list-meta">
                                                <time datetime={article.published_at}>
                                                    {formatDate(article.published_at)}
                                                </time>
                                                <span class="separator">•</span>
                                                <span>{calculateReadTime(article.content)} min</span>
                                            </div>
                                        </a>
                                    </article>
                                ))}
                            </div>
                        </section>
                    )}
                </>
            )}
        </div>
    </main>
</Layout>

<style>
    /* Newsletter Header */
    .newsletter-header {
        background: var(--dark-surface);
        padding: 120px 24px 60px;
        text-align: center;
        border-bottom: 1px solid var(--border-subtle);
    }

    .header-content {
        max-width: 700px;
        margin: 0 auto;
    }

    .section-badge {
        display: inline-block;
        font-size: 0.75rem;
        font-weight: 700;
        color: var(--primary);
        text-transform: uppercase;
        letter-spacing: 2px;
        margin-bottom: 16px;
    }

    .newsletter-header h1 {
        font-size: clamp(2.5rem, 5vw, 3.5rem);
        font-weight: 800;
        color: var(--text-primary);
        line-height: 1.1;
        margin-bottom: 16px;
    }

    .newsletter-header h1 .accent {
        color: var(--primary);
    }

    .newsletter-header p {
        font-size: 1.125rem;
        color: #e0e0e0;
        line-height: 1.6;
    }

    /* Light mode header styling */
    :global(body.theme-light) .section-badge {
        color: #1a365d;
    }

    :global(body.theme-light) .newsletter-header h1 .accent {
        color: #1a365d;
    }

    :global(body.theme-light) .newsletter-header p {
        color: var(--text-secondary);
    }

    /* Main Content */
    .newsletter-main {
        padding: 60px 24px 80px;
        background: var(--dark-bg);
    }

    .newsletter-main .container {
        max-width: 1200px;
        margin: 0 auto;
    }

    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 100px 40px;
        background: var(--dark-surface);
        border-radius: 12px;
    }

    .empty-state i {
        font-size: 3rem;
        color: var(--text-tertiary);
        margin-bottom: 24px;
        opacity: 0.5;
    }

    .empty-state h3 {
        font-size: 1.5rem;
        color: var(--text-primary);
        margin-bottom: 8px;
    }

    .empty-state p {
        color: var(--text-secondary);
    }

    /* Hero Featured Article */
    .hero-featured {
        margin-bottom: 60px;
    }

    .hero-link {
        display: grid;
        grid-template-columns: 1.2fr 1fr;
        gap: 40px;
        text-decoration: none;
        color: inherit;
        align-items: center;
    }

    .hero-image {
        position: relative;
        border-radius: 12px;
        overflow: hidden;
        aspect-ratio: 16/10;
    }

    .hero-image img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 0.4s ease;
    }

    .hero-link:hover .hero-image img {
        transform: scale(1.03);
    }

    .hero-category {
        position: absolute;
        top: 16px;
        left: 16px;
        background: var(--primary);
        color: var(--dark-bg);
        font-size: 0.6875rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 1px;
        padding: 6px 12px;
        border-radius: 4px;
    }

    :global(body.theme-light) .hero-category {
        background: #1a365d;
        color: #ffffff;
    }

    .hero-content h2 {
        font-size: clamp(1.75rem, 3vw, 2.25rem);
        font-weight: 700;
        color: var(--text-primary);
        line-height: 1.2;
        margin-bottom: 16px;
        transition: color 0.2s;
    }

    .hero-link:hover .hero-content h2 {
        color: var(--primary);
    }

    .hero-excerpt {
        font-size: 1.0625rem;
        color: var(--text-secondary);
        line-height: 1.7;
        margin-bottom: 20px;
    }

    .hero-meta {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.875rem;
        color: var(--text-tertiary);
    }

    .hero-meta .author {
        font-weight: 600;
        color: var(--text-secondary);
    }

    .separator {
        color: var(--border-medium);
    }

    /* Section Title */
    .section-title {
        font-size: 0.8125rem;
        font-weight: 700;
        color: var(--text-tertiary);
        text-transform: uppercase;
        letter-spacing: 1.5px;
        padding-bottom: 16px;
        margin-bottom: 32px;
        border-bottom: 2px solid var(--primary);
        display: inline-block;
    }

    :global(body.theme-light) .section-title {
        border-bottom-color: #1a365d;
    }

    /* Article Grid */
    .article-grid-section {
        margin-bottom: 60px;
    }

    .article-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 32px;
    }

    .article-card {
        background: var(--dark-card);
        border: 1px solid var(--border-subtle);
        border-radius: 12px;
        overflow: hidden;
        transition: all 0.3s ease;
    }

    .article-card:hover {
        border-color: var(--primary);
        transform: translateY(-4px);
        box-shadow: var(--shadow);
    }

    :global(body.theme-light) .article-card {
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
    }

    :global(body.theme-light) .article-card:hover {
        border-color: #1a365d;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
    }

    .card-link {
        text-decoration: none;
        color: inherit;
        display: block;
    }

    .card-image {
        position: relative;
        aspect-ratio: 16/9;
        overflow: hidden;
    }

    .card-image img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 0.4s ease;
    }

    .card-link:hover .card-image img {
        transform: scale(1.05);
    }

    .card-category {
        position: absolute;
        top: 12px;
        left: 12px;
        background: var(--primary);
        color: var(--dark-bg);
        font-size: 0.625rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        padding: 4px 8px;
        border-radius: 3px;
    }

    :global(body.theme-light) .card-category {
        background: #1a365d;
        color: #ffffff;
    }

    .card-content {
        padding: 20px;
    }

    .card-content h4 {
        font-size: 1.125rem;
        font-weight: 700;
        color: var(--text-primary);
        line-height: 1.3;
        margin-bottom: 10px;
        transition: color 0.2s;
    }

    .card-link:hover .card-content h4 {
        color: var(--primary);
    }

    .card-excerpt {
        font-size: 0.9375rem;
        color: var(--text-secondary);
        line-height: 1.6;
        margin-bottom: 16px;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    .card-meta {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 0.8125rem;
        color: var(--text-tertiary);
    }

    .card-meta .author {
        font-weight: 600;
        color: var(--text-secondary);
    }

    /* More Articles Section */
    .more-articles-section {
        padding-top: 40px;
        border-top: 1px solid var(--border-subtle);
    }

    .more-articles-list {
        display: grid;
        gap: 24px;
    }

    .list-article {
        padding-bottom: 24px;
        border-bottom: 1px solid var(--border-subtle);
    }

    .list-article:last-child {
        border-bottom: none;
    }

    .list-link {
        text-decoration: none;
        color: inherit;
        display: block;
    }

    .list-link:hover h4 {
        color: var(--primary);
    }

    .list-category {
        display: inline-block;
        font-size: 0.625rem;
        font-weight: 700;
        color: var(--primary);
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-bottom: 8px;
    }

    :global(body.theme-light) .list-category {
        color: #1a365d;
    }

    .list-article h4 {
        font-size: 1.125rem;
        font-weight: 600;
        color: var(--text-primary);
        line-height: 1.4;
        margin-bottom: 8px;
        transition: color 0.2s;
    }

    .list-meta {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 0.8125rem;
        color: var(--text-tertiary);
    }

    /* Responsive */
    @media (max-width: 1024px) {
        .hero-link {
            grid-template-columns: 1fr;
            gap: 24px;
        }

        .article-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    @media (max-width: 768px) {
        .newsletter-header {
            padding: 100px 16px 40px;
        }

        .newsletter-main {
            padding: 40px 16px 60px;
        }

        .article-grid {
            grid-template-columns: 1fr;
        }

        .hero-featured {
            margin-bottom: 40px;
        }
    }
</style>
